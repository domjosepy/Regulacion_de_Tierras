{% extends "base.html" %}
{% load static %}

{% block title %}Panel de Administración Integrado{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado con breadcrumb -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Panel de Administración</h1>
        <div>
            <button class="btn btn-success" data-toggle="modal" data-target="#crearUsuarioModal">
                <i class="fas fa-user-plus"></i> Crear Usuario
            </button>
        </div>
    </div>
    
    <!-- Estadísticas mejoradas -->
    <div class="row">
        <!-- Usuarios Totales -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Usuarios Totales</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_usuarios }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pendientes de Rol -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pendientes de Rol</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ usuarios_pendientes.count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Usuarios Activos -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Usuarios Activos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ usuarios_activos.count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Última Actividad -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Última Actividad</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ ultima_actividad|date:"d/m/Y" }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-history fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pestañas para Gestión de Usuarios -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <ul class="nav nav-tabs card-header-tabs" id="usersTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="recent-tab" data-toggle="tab" href="#recent" role="tab" aria-controls="recent" aria-selected="true">
                        <i class="fas fa-users"></i> Recientes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pending-tab" data-toggle="tab" href="#pending" role="tab" aria-controls="pending" aria-selected="false">
                        <i class="fas fa-user-clock"></i> Pendientes ({{ usuarios_pendientes.count }})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="active-tab" data-toggle="tab" href="#active" role="tab" aria-controls="active" aria-selected="false">
                        <i class="fas fa-user-check"></i> Activos ({{ usuarios_activos.count }})
                    </a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="usersTabsContent">
                <!-- Pestaña Usuarios Recientes -->
                <div class="tab-pane fade show active" id="recent" role="tabpanel" aria-labelledby="recent-tab">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="recentTable" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Username</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Fecha Registro</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in nuevos_usuarios %}
                                <tr>
                                    <td>{{ usuario.username }}</td>
                                    <td>{{ usuario.first_name }} {{ usuario.last_name }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td>{{ usuario.date_joined|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        {% if not usuario.rol or usuario.rol == 'PENDIENTE' %}
                                            <span class="badge badge-warning">Pendiente</span>
                                        {% else %}
                                            <span class="badge badge-success">Activo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary asignar-rol-btn" 
                                                data-userid="{{ usuario.id }}" 
                                                data-username="{{ usuario.username }}"
                                                {% if usuario.rol %}data-currentrole="{{ usuario.rol }}"{% endif %}
                                                data-isactive="{{ usuario.is_active|yesno:'true,false' }}"
                                                data-toggle="modal" 
                                                data-target="#asignarRolModal">
                                            <i class="fas fa-user-tag"></i> Rol
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No hay usuarios nuevos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Pestaña Usuarios Pendientes -->
                <div class="tab-pane fade" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="pendingTable" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Username</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Fecha Registro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in usuarios_pendientes %}
                                <tr>
                                    <td>{{ usuario.username }}</td>
                                    <td>{{ usuario.first_name }} {{ usuario.last_name }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td>{{ usuario.date_joined|date:"d/m/Y" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary asignar-rol-btn" 
                                                data-userid="{{ usuario.id }}" 
                                                data-username="{{ usuario.username }}"
                                                data-toggle="modal" 
                                                data-target="#asignarRolModal">
                                            <i class="fas fa-user-tag"></i> Asignar Rol
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">No hay usuarios pendientes</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Pestaña Usuarios Activos -->
                <div class="tab-pane fade" id="active" role="tabpanel" aria-labelledby="active-tab">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="activeTable" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Username</th>
                                    <th>Nombre</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in usuarios_activos %}
                                <tr>
                                    <td>{{ usuario.username }}</td>
                                    <td>{{ usuario.first_name }} {{ usuario.last_name }}</td>
                                    <td>
                                        <span class="badge badge-{{ usuario.get_rol_color }}">
                                            {{ usuario.get_rol_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if usuario.is_active %}
                                            <span class="badge badge-success">Activo</span>
                                        {% else %}
                                            <span class="badge badge-danger">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info asignar-rol-btn" 
                                                data-userid="{{ usuario.id }}" 
                                                data-username="{{ usuario.username }}"
                                                data-currentrole="{{ usuario.rol }}"
                                                data-isactive="{{ usuario.is_active|yesno:'true,false' }}"
                                                data-toggle="modal" 
                                                data-target="#asignarRolModal">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">No hay usuarios activos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Asignar/Editar Rol -->
{% include 'includes/modals/asignar_rol_modal.html' %}

<!-- Modal para Crear Usuario -->
<div class="modal fade" id="crearUsuarioModal" tabindex="-1" role="dialog" aria-labelledby="crearUsuarioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="crearUsuarioModalLabel">Crear Nuevo Usuario</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="crearUsuarioForm" method="post" action="{% url 'sistema:crear_usuario' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="username">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="email">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="password1">Contraseña</label>
                            <input type="password" class="form-control" id="password1" name="password1" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="password2">Confirmar Contraseña</label>
                            <input type="password" class="form-control" id="password2" name="password2" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="rol">Rol</label>
                            <select class="form-control" id="rol" name="rol" required>
                                <option value="">Seleccione un rol</option>
                                <option value="ADMIN">Administrador</option>
                                <option value="GERENTE">Gerente</option>
                                <option value="MONITOREO">Jefe de Monitoreo</option>
                                <option value="ANALISIS">Jefe de Análisis</option>
                                <option value="EXPEDIENTES">Jefe de Expedientes</option>
                                <option value="RELEVAMIENTO">Jefe de Relevamiento</option>
                                <option value="SIG">Jefe de SIG</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <div class="custom-control custom-switch mt-4 pt-2">
                                <input type="checkbox" class="custom-control-input" id="is_active" name="is_active" checked>
                                <label class="custom-control-label" for="is_active">Usuario Activo</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<!-- jQuery DEBE cargarse primero -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Luego Bootstrap Bundle (que incluye Popper.js) -->
<script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>

<!-- Tu código JavaScript personalizado -->
<script>
$(document).ready(function() {
    // Inicializar DataTables con configuración mejorada
    $('#recentTable, #pendingTable, #activeTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
        },
        "order": [[3, "desc"]],
        "responsive": true,
        "dom": '<"top"lf>rt<"bottom"ip><"clear">',
        "pageLength": 10,
        "lengthMenu": [5, 10, 25, 50, 100],
        "columnDefs": [
            { "orderable": false, "targets": -1 } // Deshabilitar ordenamiento en columna de acciones
        ]
    });
    
    // Configurar el modal de asignación de roles
    $('#asignarRolModal').on('show.bs.modal', function(event) {
        var button = $(event.relatedTarget);
        var userId = button.data('userid');
        var username = button.data('username');
        var currentRole = button.data('currentrole') || '';
        var isActive = button.data('isactive') === 'true' || button.data('isactive') === true;
        
        var modal = $(this);
        modal.find('#user_id').val(userId);
        modal.find('#username-display').text(username);
        modal.find('#rol').val(currentRole);
        modal.find('#is_active').prop('checked', isActive);
    });
    
    // Manejar el envío del formulario de creación de usuario
    $('#crearUsuarioForm').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var submitBtn = form.find('button[type="submit"]');
        
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creando...');
        
        $.ajax({
            type: "POST",
            url: form.attr('action'),
            data: form.serialize(),
            success: function(response) {
                if(response.success) {
                    ToastManager.createToast('Usuario creado exitosamente', 'success');
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    ToastManager.createToast(response.message || 'Error al crear usuario', 'danger');
                    submitBtn.prop('disabled', false).html('<i class="fas fa-save"></i> Crear Usuario');
                }
            },
            error: function(xhr) {
                ToastManager.createToast('Error en la solicitud: ' + (xhr.responseJSON?.message || ''), 'danger');
                submitBtn.prop('disabled', false).html('<i class="fas fa-save"></i> Crear Usuario');
            }
        });
    });
});
</script>
{% endblock %}